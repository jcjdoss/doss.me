<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚öîÔ∏è The Quest Log ‚Äî Agent Party</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a1a;
  --panel: #0d1040;
  --border: #8888cc;
  --border-inner: #444488;
  --highlight: rgba(204,204,255,0.3);
  --gold: #ffd700;
  --white: #fff;
  --muted: #8888aa;
  --green: #22cc44;
  --red: #cc2222;
  --blue: #4488ff;
  --purple: #aa44ff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--bg);
  color: var(--white);
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  line-height: 1.6;
  min-height: 100vh;
}
body::after {
  content:'';position:fixed;top:0;left:0;right:0;bottom:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);
  pointer-events:none;z-index:9999;
}

.dashboard { max-width:1100px; margin:0 auto; padding:20px 16px; }

.title {
  text-align:center; margin-bottom:24px;
}
.title h1 { font-size:18px; color:var(--gold); letter-spacing:2px; margin-bottom:4px; }
.title .sub { font-size:8px; color:var(--muted); }

/* RPG panel */
.panel {
  background:var(--panel);
  border:3px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:16px;
  box-shadow: inset 0 0 0 2px var(--border-inner), 0 0 20px rgba(68,68,136,0.3);
  position:relative;
}
.panel::before {
  content:'';position:absolute;top:2px;left:2px;right:2px;bottom:2px;
  border:1px solid var(--highlight);border-radius:5px;pointer-events:none;
}
.panel-title {
  position:absolute;top:-10px;left:16px;
  background:var(--panel);padding:0 8px;
  font-size:9px;color:var(--gold);letter-spacing:1px;
}

/* Formation area */
#formation { display:block; margin:0 auto; image-rendering:pixelated; }

/* Character grid */
.char-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap:16px;
  margin-top:12px;
}
.char-card {
  background:rgba(0,0,0,0.3);
  border:2px solid var(--border-inner);
  border-radius:6px;
  padding:12px;
  display:flex;
  gap:12px;
  align-items:flex-start;
  transition: border-color 0.3s;
}
.char-card:hover { border-color: var(--gold); }

.char-sprite {
  width:64px; height:64px;
  image-rendering:pixelated;
  flex-shrink:0;
}
.char-info { flex:1; min-width:0; }
.char-name { font-size:11px; margin-bottom:2px; }
.char-class { font-size:7px; color:var(--muted); margin-bottom:6px; }
.char-role { font-size:7px; color:var(--muted); margin-bottom:8px; font-style:italic; }

/* Stat bars */
.stat-row {
  display:flex; align-items:center; gap:6px; margin-bottom:3px;
}
.stat-label { width:28px; font-size:7px; color:var(--muted); }
.stat-bar-bg {
  flex:1; height:6px; background:rgba(255,255,255,0.1);
  border-radius:2px; overflow:hidden;
}
.stat-bar {
  height:100%; border-radius:2px;
  transition: width 0.8s ease;
}
.stat-val { width:20px; font-size:7px; text-align:right; }

/* Level/XP badge */
.level-badge {
  text-align:center; margin-bottom:6px;
}
.level-num { font-size:16px; color:var(--gold); }
.level-label { font-size:7px; color:var(--muted); }
.xp-bar-bg {
  width:100%; height:4px; background:rgba(255,255,255,0.1);
  border-radius:2px; overflow:hidden; margin-top:2px;
}
.xp-bar { height:100%; background:var(--purple); border-radius:2px; transition: width 0.8s; }

/* Battle record */
.battle-rec { font-size:7px; color:var(--muted); margin-top:6px; }
.battle-rec .wins { color:var(--green); }
.battle-rec .losses { color:var(--red); }

/* Strengths/Weaknesses */
.traits { font-size:7px; margin-top:4px; }
.traits .strong { color:var(--green); }
.traits .weak { color:var(--red); }

/* Battle log */
.log-entries { max-height:200px; overflow-y:auto; }
.log-entry {
  font-size:8px; padding:4px 8px; margin-bottom:2px;
  border-left:3px solid var(--muted);
  background:rgba(0,0,0,0.2);
}
.log-entry.win { border-color:var(--green); }
.log-entry.loss { border-color:var(--red); }
.log-entry.critical { border-color:var(--gold); }
.log-empty { color:var(--muted); font-size:8px; text-align:center; padding:20px; }
.log-empty .cursor { animation: blink 1s step-end infinite; }
@keyframes blink { 50% { opacity:0; } }

/* Leaderboard */
.lb-list { list-style:none; }
.lb-entry {
  display:flex; align-items:center; gap:8px;
  padding:6px 8px; margin-bottom:4px;
  background:rgba(0,0,0,0.2); border-radius:4px;
}
.lb-rank { width:20px; font-size:10px; text-align:center; }
.lb-rank.first { color:var(--gold); text-shadow:0 0 8px rgba(255,215,0,0.6); }
.lb-sprite { width:24px; height:24px; image-rendering:pixelated; }
.lb-name { flex:1; font-size:8px; }
.lb-xp { font-size:8px; color:var(--purple); }
.lb-level { font-size:8px; color:var(--gold); }

/* Summary bar */
.summary {
  display:flex; justify-content:center; gap:24px; flex-wrap:wrap;
  font-size:8px; margin-bottom:4px;
}
.summary-item .val { color:var(--gold); font-size:11px; }

/* Hover float name */
.float-name {
  position:absolute; font-size:7px; text-align:center;
  color:var(--gold); pointer-events:none;
  text-shadow: 0 0 4px rgba(255,215,0,0.5);
}

/* Responsive */
@media (max-width:640px) {
  .char-grid { grid-template-columns:1fr; }
  .dashboard { padding:10px 8px; }
}
</style>
</head>
<body>
<div class="dashboard">
  <div class="title">
    <h1>‚öîÔ∏è THE QUEST LOG</h1>
    <div class="sub">Agent Party Dashboard ‚Ä¢ Auto-updates every 30s</div>
  </div>

  <!-- Summary -->
  <div class="panel" style="text-align:center;">
    <div class="summary" id="summary"></div>
  </div>

  <!-- Formation -->
  <div class="panel">
    <div class="panel-title">FORMATION</div>
    <canvas id="formation" width="384" height="96"></canvas>
  </div>

  <!-- Character Cards -->
  <div class="panel">
    <div class="panel-title">PARTY ROSTER</div>
    <div class="char-grid" id="roster"></div>
  </div>

  <!-- Leaderboard -->
  <div class="panel">
    <div class="panel-title">LEADERBOARD</div>
    <ol class="lb-list" id="leaderboard"></ol>
  </div>

  <!-- Battle Log -->
  <div class="panel">
    <div class="panel-title">BATTLE LOG</div>
    <div class="log-entries" id="battleLog"></div>
  </div>
</div>

<script>
// ===== PIXEL ART SPRITES (16x16 grid, drawn on canvas) =====
// Each sprite is a 2D array of hex colors (null = transparent)
const SPRITES = {
  clawd: {
    // Paladin - gold armor, sword, red cape
    pixels: [
      [null,null,null,null,null,null,'#ccc',null,null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#ccc','#fff','#ccc',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,null,'#ccc',null,null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#ffd700','#ffd700','#ffd700',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#ffd700','#ffd700','#ffd700','#ffd700','#ffd700',null,null,null,null,null,null,null],
      [null,null,null,null,'#ffd700','#fce4a8','#fce4a8','#fce4a8','#ffd700',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#c44','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#cc0000','#ffd700','#ffd700','#ffd700','#cc0000',null,null,null,null,null,null,null],
      [null,null,null,'#cc0000','#cc0000','#ffd700','#ffd700','#ffd700','#cc0000','#cc0000',null,null,null,null,null,null],
      [null,null,'#ccc','#cc0000','#fce4a8','#ffd700','#ffd700','#ffd700','#fce4a8','#cc0000',null,null,null,null,null,null],
      [null,null,null,null,'#fce4a8','#ffd700','#ffd700','#ffd700','#fce4a8',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#ffd700','#ffd700','#ffd700',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#8B6914','#222','#8B6914',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#8B6914',null,'#8B6914',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#8B6914','#8B6914',null,'#8B6914','#8B6914',null,null,null,null,null,null,null],
    ]
  },
  scout: {
    // Ranger - green hood, bow
    pixels: [
      [null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#228B22','#228B22','#228B22',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#228B22','#228B22','#1a6b1a','#228B22','#228B22',null,null,null,null,null,null,null],
      [null,null,null,null,'#228B22','#1a6b1a','#1a6b1a','#1a6b1a','#228B22',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#2d5a1e','#2d5a1e','#2d5a1e',null,null,null,'#8B4513',null,null,null,null],
      [null,null,null,null,'#2d5a1e','#2d5a1e','#2d5a1e','#2d5a1e','#2d5a1e',null,'#8B4513',null,'#8B4513',null,null,null],
      [null,null,null,'#228B22','#228B22','#2d5a1e','#2d5a1e','#2d5a1e','#228B22','#228B22','#8B4513',null,'#8B4513',null,null,null],
      [null,null,null,null,'#fce4a8','#2d5a1e','#2d5a1e','#2d5a1e','#fce4a8',null,null,'#ccc',null,null,null,null],
      [null,null,null,null,null,'#2d5a1e','#2d5a1e','#2d5a1e',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#2d5a1e','#222','#2d5a1e',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#8B4513',null,'#8B4513',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#8B4513',null,'#8B4513',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#2d5a1e','#2d5a1e',null,'#2d5a1e','#2d5a1e',null,null,null,null,null,null,null],
    ]
  },
  keeper: {
    // Cleric - blue robes, staff with glow
    pixels: [
      [null,null,null,null,null,null,null,null,null,null,'#88ccff',null,null,null,null,null],
      [null,null,null,null,null,null,null,null,null,null,'#4169E1','#88ccff',null,null,null,null],
      [null,null,null,null,null,'#4169E1','#4169E1','#4169E1',null,null,'#88ccff',null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#4169E1','#4169E1','#4169E1','#4169E1','#4169E1',null,null,null,null,null,null,null],
      [null,null,null,'#4169E1','#4169E1','#2a4a9a','#fff','#2a4a9a','#4169E1','#4169E1',null,null,null,null,null,null],
      [null,null,null,null,'#fce4a8','#2a4a9a','#2a4a9a','#2a4a9a','#fce4a8','#8B4513',null,null,null,null,null,null],
      [null,null,null,null,null,'#2a4a9a','#2a4a9a','#2a4a9a',null,'#8B4513',null,null,null,null,null,null],
      [null,null,null,null,'#4169E1','#4169E1','#4169E1','#4169E1','#4169E1','#8B4513',null,null,null,null,null,null],
      [null,null,null,null,'#4169E1','#4169E1','#4169E1','#4169E1','#4169E1','#8B4513',null,null,null,null,null,null],
      [null,null,null,null,'#4169E1','#4169E1','#4169E1','#4169E1','#4169E1','#8B4513',null,null,null,null,null,null],
      [null,null,null,null,null,'#2a4a9a',null,'#2a4a9a',null,'#8B4513',null,null,null,null,null,null],
      [null,null,null,null,null,'#2a4a9a',null,'#2a4a9a',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#4169E1','#4169E1',null,'#4169E1','#4169E1',null,null,null,null,null,null,null],
    ]
  },
  sentinel: {
    // Knight - silver armor, big shield
    pixels: [
      [null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#aaa','#ccc','#aaa',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#aaa','#ccc','#ddd','#ccc','#aaa',null,null,null,null,null,null,null],
      [null,null,null,null,'#888','#aaa','#ccc','#aaa','#888',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,'#888','#aaa','#aaa','#ccc','#ccc','#ccc','#aaa',null,null,null,null,null,null,null],
      [null,'#888','#aaa','#cc2222','#aaa','#aaa','#aaa','#aaa','#aaa','#aaa',null,null,null,null,null,null],
      [null,'#888','#aaa','#cc2222','#cc2222','#aaa','#aaa','#aaa','#fce4a8',null,null,null,null,null,null,null],
      [null,'#888','#aaa','#cc2222','#aaa','#aaa','#aaa','#aaa','#fce4a8',null,null,null,null,null,null,null],
      [null,null,'#888','#aaa','#aaa','#aaa','#aaa','#aaa',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#aaa','#222','#aaa',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#888',null,'#888',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#888',null,'#888',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#aaa','#aaa',null,'#aaa','#aaa',null,null,null,null,null,null,null],
    ]
  },
  scribe: {
    // Mage - purple hat with star, book
    pixels: [
      [null,null,null,null,null,null,'#ffd700',null,null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#800080','#800080','#800080',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#800080','#800080','#800080','#800080','#800080',null,null,null,null,null,null,null],
      [null,null,null,'#800080','#800080','#800080','#800080','#800080','#800080','#800080',null,null,null,null,null,null],
      [null,null,'#6a006a','#6a006a','#6a006a','#6a006a','#6a006a','#6a006a','#6a006a','#6a006a','#6a006a',null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#6a006a','#800080','#800080','#800080','#6a006a',null,null,null,null,null,null,null],
      [null,null,null,'#6a006a','#fce4a8','#800080','#800080','#800080','#fce4a8','#6a006a',null,null,null,null,null,null],
      [null,null,null,null,null,'#800080','#800080','#800080',null,null,'#8B4513','#ffd700',null,null,null,null],
      [null,null,null,null,'#800080','#800080','#800080','#800080','#800080',null,'#8B4513','#fff',null,null,null,null],
      [null,null,null,null,'#800080','#800080','#800080','#800080','#800080',null,'#8B4513','#ffd700',null,null,null,null],
      [null,null,null,null,null,'#6a006a',null,'#6a006a',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#6a006a',null,'#6a006a',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#800080','#800080',null,'#800080','#800080',null,null,null,null,null,null,null],
    ]
  },
  herald: {
    // Bard - orange feathered hat, lute
    pixels: [
      [null,null,null,null,null,null,null,'#22cc44',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#FF8C00','#FF8C00','#FF8C00',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#FF8C00','#FF8C00','#cc7000','#FF8C00','#FF8C00',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#FF8C00','#FF8C00','#FF8C00',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#fce4a8','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#222','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#fce4a8','#c44','#fce4a8',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#FF8C00','#FF8C00','#FF8C00','#FF8C00','#FF8C00',null,null,null,null,null,null,null],
      [null,null,null,'#FF8C00','#fce4a8','#cc7000','#cc7000','#cc7000','#fce4a8','#FF8C00',null,null,null,null,null,null],
      [null,null,null,null,'#fce4a8','#cc7000','#cc7000','#cc7000','#fce4a8',null,null,null,null,null,null,null],
      [null,null,null,null,null,'#cc7000','#cc7000','#cc7000',null,'#8B4513',null,null,null,null,null,null],
      [null,null,null,null,null,'#cc7000','#cc7000','#cc7000','#8B4513','#ffd700','#8B4513',null,null,null,null,null],
      [null,null,null,null,null,'#cc7000','#cc7000','#cc7000',null,'#8B4513',null,null,null,null,null,null],
      [null,null,null,null,null,'#8B4513',null,'#8B4513',null,null,null,null,null,null,null,null],
      [null,null,null,null,null,'#8B4513',null,'#8B4513',null,null,null,null,null,null,null,null],
      [null,null,null,null,'#FF8C00','#FF8C00',null,'#FF8C00','#FF8C00',null,null,null,null,null,null,null],
    ]
  }
};

const STAT_COLORS = {
  STR:'#cc2222', SPD:'#ffd700', INT:'#4488ff', WIS:'#aa44ff', CON:'#22cc44', CHA:'#ff8c00'
};

let data = null;
let frame = 0;

// Draw a sprite on canvas at given position and scale
function drawSprite(ctx, key, x, y, scale) {
  const sprite = SPRITES[key];
  if (!sprite) return;
  const px = sprite.pixels;
  for (let row = 0; row < px.length; row++) {
    for (let col = 0; col < px[row].length; col++) {
      if (px[row][col]) {
        ctx.fillStyle = px[row][col];
        ctx.fillRect(x + col * scale, y + row * scale, scale, scale);
      }
    }
  }
}

// Draw name + level above sprite on formation
function drawLabel(ctx, name, level, x, y, color) {
  ctx.fillStyle = color || '#ffd700';
  ctx.font = '7px "Press Start 2P"';
  ctx.textAlign = 'center';
  ctx.fillText(name, x + 24, y - 6);
  ctx.fillStyle = '#8888aa';
  ctx.font = '6px "Press Start 2P"';
  ctx.fillText('Lv.' + level, x + 24, y + 54);
}

// Render formation canvas
function renderFormation() {
  const canvas = document.getElementById('formation');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!data) return;
  const keys = Object.keys(data.party);
  const spacing = 64;
  const startX = (canvas.width - keys.length * spacing) / 2;
  const baseY = 16;
  const bob = Math.sin(frame * 0.08) * 2;

  keys.forEach((key, i) => {
    const p = data.party[key];
    const yOff = i % 2 === 0 ? bob : -bob; // alternating bob
    drawSprite(ctx, key, startX + i * spacing, baseY + yOff, 3);
    drawLabel(ctx, p.name, p.level, startX + i * spacing, baseY + yOff, p.color);
  });
}

// Render character cards
function renderRoster() {
  const el = document.getElementById('roster');
  if (!data) return;
  el.innerHTML = '';

  Object.entries(data.party).forEach(([key, p]) => {
    const winRate = p.battles.total > 0 ? Math.round(p.battles.wins / p.battles.total * 100) : 0;
    const xpPct = p.nextLevelXp > 0 ? Math.round(p.xp / p.nextLevelXp * 100) : 0;

    const statsHtml = Object.entries(p.stats).map(([stat, val]) => {
      const maxStat = 20; // Level 1 reasonable max
      const pct = Math.min(100, (val / maxStat) * 100);
      const color = STAT_COLORS[stat] || '#888';
      return `<div class="stat-row">
        <span class="stat-label">${stat}</span>
        <div class="stat-bar-bg"><div class="stat-bar" style="width:${pct}%;background:${color}"></div></div>
        <span class="stat-val">${val}</span>
      </div>`;
    }).join('');

    const strongHtml = (p.strengths || []).map(s => `<span class="strong">+${s}</span>`).join(' ');
    const weakHtml = (p.weaknesses || []).map(s => `<span class="weak">-${s}</span>`).join(' ');

    const cronsHtml = (p.crons || []).map(c => `<span style="color:#4488ff">‚öô ${c}</span>`).join('<br>');

    const card = document.createElement('div');
    card.className = 'char-card';
    card.innerHTML = `
      <div>
        <canvas class="char-sprite" width="64" height="64" data-sprite="${key}"></canvas>
      </div>
      <div class="char-info">
        <div class="char-name" style="color:${p.color}">${p.emoji} ${p.name}</div>
        <div class="char-class">${p.class} ‚Ä¢ ${p.title} ‚Ä¢ ${p.model}</div>
        <div class="char-role">${p.role || ''}</div>
        <div class="level-badge">
          <span class="level-num">Lv.${p.level}</span>
          <div class="xp-bar-bg"><div class="xp-bar" style="width:${xpPct}%"></div></div>
          <span class="level-label">XP ${p.xp}/${p.nextLevelXp}</span>
        </div>
        ${statsHtml}
        <div class="battle-rec">
          ‚öî ${p.battles.total} battles ‚Ä¢
          <span class="wins">${p.battles.wins}W</span> /
          <span class="losses">${p.battles.defeats}L</span>
          ${p.battles.total > 0 ? ' ‚Ä¢ ' + winRate + '% win' : ''}
          ${p.streak > 0 ? ' ‚Ä¢ üî•' + p.streak : ''}
        </div>
        <div class="traits">${strongHtml} ${weakHtml}</div>
        ${cronsHtml ? '<div style="font-size:7px;margin-top:4px">' + cronsHtml + '</div>' : ''}
      </div>
    `;
    el.appendChild(card);

    // Draw sprite on card canvas
    const cv = card.querySelector('canvas');
    const ctx = cv.getContext('2d');
    drawSprite(ctx, key, 0, 0, 4);
  });
}

// Render leaderboard
function renderLeaderboard() {
  const el = document.getElementById('leaderboard');
  if (!data) return;

  const sorted = Object.entries(data.party).sort((a, b) => {
    if (b[1].level !== a[1].level) return b[1].level - a[1].level;
    return b[1].xp - a[1].xp;
  });

  el.innerHTML = sorted.map(([key, p], i) => {
    const rank = i + 1;
    return `<li class="lb-entry">
      <span class="lb-rank ${rank === 1 ? 'first' : ''}">${rank === 1 ? 'üëë' : '#' + rank}</span>
      <canvas class="lb-sprite" width="24" height="24" data-sprite="${key}" data-scale="1.5"></canvas>
      <span class="lb-name" style="color:${p.color}">${p.name}</span>
      <span class="lb-level">Lv.${p.level}</span>
      <span class="lb-xp">${p.xp}xp</span>
    </li>`;
  }).join('');

  // Draw mini sprites
  el.querySelectorAll('canvas[data-sprite]').forEach(cv => {
    const ctx = cv.getContext('2d');
    drawSprite(ctx, cv.dataset.sprite, 0, 0, 1.5);
  });
}

// Render battle log
function renderBattleLog() {
  const el = document.getElementById('battleLog');
  if (!data || !data.battleLog || data.battleLog.length === 0) {
    el.innerHTML = '<div class="log-empty">Awaiting first encounter<span class="cursor">_</span></div>';
    return;
  }

  el.innerHTML = data.battleLog.slice(-20).reverse().map(entry => {
    const cls = entry.result === 'critical' ? 'critical' : entry.result === 'win' ? 'win' : 'loss';
    const icon = entry.result === 'critical' ? '‚ö°' : entry.result === 'win' ? '‚úÖ' : 'üíÄ';
    return `<div class="log-entry ${cls}">
      ${icon} <strong>${entry.agent}</strong> vs ${entry.task || 'Unknown'} ‚Äî ${entry.result}
      ${entry.xp ? '(+' + entry.xp + 'xp)' : ''}
      <span style="float:right;color:var(--muted)">${entry.time || ''}</span>
    </div>`;
  }).join('');
}

// Render summary bar
function renderSummary() {
  const el = document.getElementById('summary');
  if (!data) return;

  const party = Object.values(data.party);
  const totalLevel = party.reduce((s, p) => s + p.level, 0);
  const totalBattles = party.reduce((s, p) => s + p.battles.total, 0);
  const totalWins = party.reduce((s, p) => s + p.battles.wins, 0);
  const winRate = totalBattles > 0 ? Math.round(totalWins / totalBattles * 100) : 0;

  el.innerHTML = `
    <div class="summary-item">AGENTS<br><span class="val">${party.length}</span></div>
    <div class="summary-item">TOTAL LV<br><span class="val">${totalLevel}</span></div>
    <div class="summary-item">BATTLES<br><span class="val">${totalBattles}</span></div>
    <div class="summary-item">WINS<br><span class="val">${totalWins}</span></div>
    <div class="summary-item">WIN RATE<br><span class="val">${winRate}%</span></div>
  `;
}

function renderAll() {
  renderSummary();
  renderFormation();
  renderRoster();
  renderLeaderboard();
  renderBattleLog();
}

// Animation loop
function animate() {
  frame++;
  renderFormation();
  requestAnimationFrame(animate);
}

// Load data
async function loadData() {
  try {
    const resp = await fetch('stats.json?t=' + Date.now());
    data = await resp.json();
    renderAll();
  } catch(e) {
    console.warn('Failed to load stats.json:', e);
  }
}

// Init
loadData().then(() => animate());
setInterval(loadData, 30000);
</script>
</body>
</html>
